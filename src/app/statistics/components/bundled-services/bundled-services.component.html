<!-- Thanh điều khiển thời gian -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="h4 mb-0">Thống kê dịch vụ đi kèm</h2>
  <div class="btn-group">
    <button class="btn" [ngClass]="timeRangeFilter === 'today' ? 'btn-primary' : 'btn-outline-primary'" (click)="applyTimeRange('today')">Hôm nay</button>
    <button class="btn" [ngClass]="timeRangeFilter === 'thisWeek' ? 'btn-primary' : 'btn-outline-primary'" (click)="applyTimeRange('thisWeek')">Tuần này</button>
    <button class="btn" [ngClass]="timeRangeFilter === 'thisMonth' ? 'btn-primary' : 'btn-outline-primary'" (click)="applyTimeRange('thisMonth')">Tháng này</button>
    <button class="btn" [ngClass]="timeRangeFilter === 'thisYear' ? 'btn-primary' : 'btn-outline-primary'" (click)="applyTimeRange('thisYear')">Năm nay</button>
  </div>
</div>

<!-- Thẻ thống kê tổng quan -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 mb-3" style="background: linear-gradient(to right, #4facfe, #00f2fe); border-radius: 15px;">
      <div class="card-body text-white">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-package-variant-closed mdi-24px mr-3"></i>
          <div>
            <h5 class="card-title mb-0">Tổng số dịch vụ đã bán</h5>
            <h3 class="font-weight-bold">{{ totalServicesCount | number }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm border-0" style="background: linear-gradient(to right, #fa709a, #fee140); border-radius: 15px;">
      <div class="card-body text-white">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-cash-multiple mdi-24px mr-3"></i>
          <div>
            <h5 class="card-title mb-0">Tổng doanh thu dịch vụ</h5>
            <h3 class="font-weight-bold">{{ formatCurrency(totalRevenue) }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hiển thị trạng thái đang tải -->
<div *ngIf="isLoading" class="text-center my-5">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Đang tải...</span>
  </div>
  <p class="mt-2">Đang tải dữ liệu...</p>
</div>

<!-- Hiển thị lỗi API (chỉ trong môi trường dev) -->
<div *ngIf="apiError" class="alert alert-danger mb-4">
  <h5>Lỗi kết nối API</h5>
  <p><strong>URL:</strong> {{ apiError.url }}</p>
  <p><strong>Status:</strong> {{ apiError.status }} {{ apiError.statusText }}</p>
  <p><strong>Message:</strong> {{ apiError.message || 'Không có thông báo lỗi' }}</p>
  <button class="btn btn-sm btn-outline-danger mt-2" (click)="apiError = null">Đóng</button>
</div>

<!-- Không có dữ liệu -->
<div *ngIf="!isLoading && topServices.length === 0" class="alert alert-info">
  <p class="mb-0">Không có dữ liệu dịch vụ để hiển thị trong khoảng thời gian đã chọn.</p>
</div>

<!-- Nội dung thống kê -->
<div *ngIf="!isLoading && topServices.length > 0">
  <!-- Hàng 1: Biểu đồ và danh sách -->
  <div class="row mb-4">
    <!-- Top dịch vụ bán chạy -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100" style="border-radius: 15px;">
        <div class="card-header bg-transparent border-0">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-star-circle mdi-24px text-warning mr-2"></i>
            <h5 class="mb-0">Top dịch vụ bán chạy</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 280px;">
            <div *ngFor="let service of topServices; let i = index" class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <span class="font-weight-medium">{{ i+1 }}. {{ service.serviceName }}</span>
                <span class="font-weight-bold">{{ service.totalSold | number }}</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" [style.width.%]="(service.totalSold / topServices[0].totalSold * 100)" [ngClass]="'bg-info'"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Doanh thu từng dịch vụ -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100" style="border-radius: 15px;">
        <div class="card-header bg-transparent border-0">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-areaspline mdi-24px text-success mr-2"></i>
            <h5 class="mb-0">Doanh thu dịch vụ</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="chart-container" style="height: 280px;">
            <div *ngFor="let service of topServices; let i = index" class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <span class="font-weight-medium">{{ i+1 }}. {{ service.serviceName }}</span>
                <span class="font-weight-bold">{{ formatCurrency(service.totalRevenue) }}</span>
              </div>
              <div class="progress" style="height: 8px;">
                <div class="progress-bar" role="progressbar" [style.width.%]="(service.totalRevenue / topServices[0].totalRevenue * 100)" [ngClass]="'bg-success'"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hàng 2: Các biểu đồ trực quan -->
  <div class="row">
    <!-- Biểu đồ tròn - Phân phối doanh thu -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100" style="border-radius: 15px;">
        <div class="card-header bg-transparent border-0">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-pie mdi-24px text-primary mr-2"></i>
            <h5 class="mb-0">Phân phối doanh thu theo dịch vụ</h5>
          </div>
        </div>
        <div class="card-body">
          <div id="pieChart">
            <apx-chart
              [series]="pieChartOptions.series!"
              [chart]="pieChartOptions.chart!"
              [labels]="pieChartOptions.labels!"
              [responsive]="pieChartOptions.responsive!"
              [colors]="pieChartOptions.colors!"
              [dataLabels]="pieChartOptions.dataLabels!"
              [legend]="pieChartOptions.legend!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- So sánh số lượng bán và doanh thu -->
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm h-100" style="border-radius: 15px;">
        <div class="card-header bg-transparent border-0">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-bar mdi-24px text-info mr-2"></i>
            <h5 class="mb-0">So sánh số lượng bán và doanh thu</h5>
          </div>
        </div>
        <div class="card-body">
          <div id="barChart">
            <apx-chart
              [series]="barChartOptions.series!"
              [chart]="barChartOptions.chart!"
              [xaxis]="barChartOptions.xaxis!"
              [yaxis]="barChartOptions.yaxis!"
              [dataLabels]="barChartOptions.dataLabels!"
              [grid]="barChartOptions.grid!"
              [legend]="barChartOptions.legend!"
              [colors]="barChartOptions.colors!"
              [tooltip]="barChartOptions.tooltip!"
              [plotOptions]="barChartOptions.plotOptions!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hàng 3: Biểu đồ đường - Doanh thu theo thời gian -->
  <div class="row" *ngIf="!isLoading && topServices.length > 0">
    <div class="col-12 mb-4">
      <div class="card shadow-sm h-100" style="border-radius: 15px;">
        <div class="card-header bg-transparent border-0">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-line mdi-24px text-purple mr-2"></i>
            <h5 class="mb-0">Biểu đồ doanh thu theo thời gian</h5>
          </div>
        </div>
        <div class="card-body">
          <div id="lineChart">
            <apx-chart
              [series]="lineChartOptions.series!"
              [chart]="lineChartOptions.chart!"
              [xaxis]="lineChartOptions.xaxis!"
              [yaxis]="lineChartOptions.yaxis!"
              [dataLabels]="lineChartOptions.dataLabels!"
              [grid]="lineChartOptions.grid!"
              [colors]="lineChartOptions.colors!"
              [stroke]="lineChartOptions.stroke!"
              [markers]="lineChartOptions.markers!"
              [tooltip]="lineChartOptions.tooltip!"
              [legend]="lineChartOptions.legend!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 