<!-- Bộ lọc khoảng thời gian và nút Export -->
<div class="row mb-3 align-items-center">
  <div class="col-md-8">
    <div class="btn-group">
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'today'"
        [class.btn-outline-primary]="timeRangeFilter !== 'today'" (click)="applyTimeRange('today')">
        Hôm nay
      </button>
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'thisWeek'"
        [class.btn-outline-primary]="timeRangeFilter !== 'thisWeek'" (click)="applyTimeRange('thisWeek')">
        Tuần này
      </button>
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'thisMonth'"
        [class.btn-outline-primary]="timeRangeFilter !== 'thisMonth'" (click)="applyTimeRange('thisMonth')">
        Tháng này
      </button>
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'thisYear'"
        [class.btn-outline-primary]="timeRangeFilter !== 'thisYear'" (click)="applyTimeRange('thisYear')">
        Năm nay
      </button>
    </div>
  </div>
  <div class="col-md-4 text-right">
    <div class="dropdown d-inline-block">
      <button class="btn btn-success dropdown-toggle" type="button" id="exportDropdown" data-toggle="dropdown" aria-expanded="false">
        <i class="mdi mdi-file-excel mr-1"></i> Xuất Excel
      </button>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="exportDropdown">
        <button class="dropdown-item" (click)="exportToExcel('gender')">
          <i class="mdi mdi-account-group text-primary mr-2"></i> Xuất thống kê giới tính
        </button>
        <button class="dropdown-item" (click)="exportToExcel('spending')">
          <i class="mdi mdi-cash-multiple text-success mr-2"></i> Xuất chi tiêu theo giới tính 
        </button>
        <div class="dropdown-divider"></div>
        <button class="dropdown-item" (click)="exportToExcel('all')">
          <i class="mdi mdi-file-document text-info mr-2"></i> Xuất tất cả dữ liệu
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Thẻ thống kê tổng quan -->
<div class="row mb-3" *ngIf="!isLoading && genderData.length > 0">
  <div class="col-md-6 mb-2">
    <div class="card shadow-sm border-0"
      style="background: linear-gradient(to right, #4facfe, #00f2fe); border-radius: 12px;">
      <div class="card-body text-white py-2">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-account-group mdi-24px mr-3"></i>
          <div>
            <h5 class="card-title mb-0">Tổng số khách hàng</h5>
            <h3 class="font-weight-bold mb-0">{{ totalCustomers | number }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-2">
    <div class="card shadow-sm border-0"
      style="background: linear-gradient(to right, #fa709a, #fee140); border-radius: 12px;">
      <div class="card-body text-white py-2">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-cash-multiple mdi-24px mr-3"></i>
          <div>
            <h5 class="card-title mb-0">Tổng chi tiêu</h5>
            <h3 class="font-weight-bold mb-0">{{ formatCurrency(totalSpent) }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hiển thị trạng thái đang tải -->
<div class="text-center p-4" *ngIf="isLoading">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Đang tải...</span>
  </div>
  <p class="mt-2">Đang tải dữ liệu...</p>
</div>

<!-- Hiển thị lỗi API nếu có -->
<div class="alert alert-danger py-2" *ngIf="!isLoading && apiError">
  <i class="mdi mdi-alert-circle mr-2"></i>
  Không thể tải dữ liệu từ API. Đang hiển thị dữ liệu mẫu.
</div>

<!-- Không có dữ liệu -->
<div *ngIf="!isLoading && genderData.length === 0" class="alert alert-info py-2">
  <p class="mb-0">Không có dữ liệu khách hàng để hiển thị trong khoảng thời gian đã chọn.</p>
</div>

<!-- Nội dung thống kê -->
<div *ngIf="!isLoading && genderData.length > 0">
  <div class="row">
    <!-- Biểu đồ tròn - Thống kê theo giới tính -->
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm h-100" style="border-radius: 12px;">
        <div class="card-header bg-transparent border-0 py-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-account-multiple mdi-24px text-primary mr-2"></i>
            <h5 class="mb-0">Thống kê theo giới tính</h5>
          </div>
        </div>
        <div class="card-body py-2">
          <div id="genderPieChart">
            <apx-chart [series]="pieChartOptions.series!" [chart]="pieChartOptions.chart!"
              [labels]="pieChartOptions.labels!" [responsive]="pieChartOptions.responsive!"
              [colors]="pieChartOptions.colors!" [dataLabels]="pieChartOptions.dataLabels!"
              [legend]="pieChartOptions.legend!" [tooltip]="pieChartOptions.tooltip!"
              [plotOptions]="pieChartOptions.plotOptions!" [states]="pieChartOptions.states!"
              [fill]="pieChartOptions.fill!"></apx-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Biểu đồ cột - So sánh chi tiêu theo giới tính -->
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm h-100" style="border-radius: 12px;">
        <div class="card-header bg-transparent border-0 py-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-bar mdi-24px text-info mr-2"></i>
            <h5 class="mb-0">Chi tiêu theo giới tính</h5>
          </div>
        </div>
        <div class="card-body py-2">
          <div id="spendingBarChart">
            <apx-chart
              [series]="barChartOptions.series!"
              [chart]="barChartOptions.chart!"
              [xaxis]="barChartOptions.xaxis!"
              [yaxis]="barChartOptions.yaxis!"
              [dataLabels]="barChartOptions.dataLabels!"
              [colors]="barChartOptions.colors!"
              [tooltip]="barChartOptions.tooltip!"
              [plotOptions]="barChartOptions.plotOptions!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Radar Chart - So sánh tương quan -->
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm h-100" style="border-radius: 12px;">
        <div class="card-header bg-transparent border-0 py-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-radar mdi-24px text-purple mr-2"></i>
            <h5 class="mb-0">So sánh tương quan</h5>
          </div>
        </div>
        <div class="card-body py-2">
          <div id="radarChart">
            <apx-chart
              [series]="radarChartOptions.series!"
              [chart]="radarChartOptions.chart!"
              [xaxis]="radarChartOptions.xaxis!"
              [dataLabels]="radarChartOptions.dataLabels!"
              [colors]="radarChartOptions.colors!"
              [tooltip]="radarChartOptions.tooltip!"
              [fill]="radarChartOptions.fill!"
              [markers]="radarChartOptions.markers!"
              [stroke]="radarChartOptions.stroke!"
              [plotOptions]="radarChartOptions.plotOptions!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Thông tin chi tiết -->
  <div class="row mb-3" *ngIf="totalCustomers > 0">
    <div class="col-12">
      <div class="card shadow-sm" style="border-radius: 12px;">
        <div class="card-header bg-transparent border-0 py-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-format-list-bulleted mdi-24px text-info mr-2"></i>
            <h5 class="mb-0">Chi tiết theo giới tính</h5>
          </div>
        </div>
        <div class="card-body py-2">
          <div class="gender-stats">
            <div *ngFor="let gender of genderData; let i = index" class="gender-item mb-3">
              <div class="d-flex align-items-center mb-1">
                <div class="gender-icon"
                  [ngClass]="{'male': gender.gender === 'Male', 'female': gender.gender === 'Female', 'other': gender.gender === 'Other'}">
                  <i class="mdi"
                    [ngClass]="{'mdi-gender-male': gender.gender === 'Male', 'mdi-gender-female': gender.gender === 'Female', 'mdi-gender-non-binary': gender.gender === 'Other'}"></i>
                </div>
                <h5 class="ml-2 mb-0">{{ translateGender(gender.gender) }}</h5>
              </div>

              <div class="stats-grid">
                <div class="stats-card total-count">
                  <div class="stats-label">Số lượng</div>
                  <div class="stats-value">{{ gender.totalCustomers | number }}</div>
                  <div class="stats-percentage">{{ calculatePercentage(gender.totalCustomers, totalCustomers) }}</div>
                  <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar"
                      [ngClass]="{'bg-info': gender.gender === 'Male', 'bg-pink': gender.gender === 'Female', 'bg-purple': gender.gender === 'Other'}"
                      [style.width.%]="(gender.totalCustomers / totalCustomers * 100)"></div>
                  </div>
                </div>

                <div class="stats-card total-spent">
                  <div class="stats-label">Chi tiêu</div>
                  <div class="stats-value">{{ formatCurrency(gender.totalSpent) }}</div>
                  <div class="stats-percentage">{{ calculatePercentage(gender.totalSpent, totalSpent) }}</div>
                  <div class="progress mt-2" style="height: 4px;">
                    <div class="progress-bar"
                      [ngClass]="{'bg-info': gender.gender === 'Male', 'bg-pink': gender.gender === 'Female', 'bg-purple': gender.gender === 'Other'}"
                      [style.width.%]="(gender.totalSpent / totalSpent * 100)"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Phân tích chi tiêu trung bình -->
  <div class="row mb-3" *ngIf="totalCustomers > 0">
    <div class="col-12">
      <div class="card shadow-sm" style="border-radius: 12px;">
        <div class="card-header bg-transparent border-0 py-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-areaspline mdi-24px text-success mr-2"></i>
            <h5 class="mb-0">Chi tiêu trung bình theo giới tính</h5>
          </div>
        </div>
        <div class="card-body py-2">
          <div class="row">
            <div *ngFor="let gender of genderData" class="col-md-4 mb-2">
              <div class="average-spending-card"
                [ngClass]="{'male-card': gender.gender === 'Male', 'female-card': gender.gender === 'Female', 'other-card': gender.gender === 'Other'}">
                <div class="gender-icon-lg">
                  <i class="mdi"
                    [ngClass]="{'mdi-gender-male': gender.gender === 'Male', 'mdi-gender-female': gender.gender === 'Female', 'mdi-gender-non-binary': gender.gender === 'Other'}"></i>
                </div>
                <h6 class="mb-1">{{ translateGender(gender.gender) }}</h6>
                <div class="avg-amount">{{ formatCurrency(gender.totalSpent / gender.totalCustomers) }}</div>
                <div class="customer-count">{{ gender.totalCustomers | number }} khách hàng</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>