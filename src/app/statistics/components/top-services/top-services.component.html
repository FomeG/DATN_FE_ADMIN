<div class="row mb-2 align-items-center">
  <div class="col-md-8">
    <div class="btn-group">
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'today'"
        [class.btn-outline-primary]="timeRangeFilter !== 'today'" (click)="applyTimeRange('today')">
        Hôm nay
      </button>
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'thisWeek'"
        [class.btn-outline-primary]="timeRangeFilter !== 'thisWeek'" (click)="applyTimeRange('thisWeek')">
        Tuần này
      </button>
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'thisMonth'"
        [class.btn-outline-primary]="timeRangeFilter !== 'thisMonth'" (click)="applyTimeRange('thisMonth')">
        Tháng này
      </button>
      <button class="btn" [class.btn-primary]="timeRangeFilter === 'thisYear'"
        [class.btn-outline-primary]="timeRangeFilter !== 'thisYear'" (click)="applyTimeRange('thisYear')">
        Năm nay
      </button>
    </div>
  </div>
  <div class="col-md-4 text-right">
    <div class="dropdown d-inline-block">
      <button class="btn btn-success dropdown-toggle py-1 px-2" type="button" id="exportDropdown" data-toggle="dropdown" aria-expanded="false">
        <i class="mdi mdi-file-excel mr-1"></i> Xuất Excel
      </button>
      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="exportDropdown">
        <button class="dropdown-item" (click)="exportToExcel('popularServices')">
          <i class="mdi mdi-food-fork-drink text-primary mr-1"></i> Xuất dịch vụ phổ biến
        </button>
        <button class="dropdown-item" (click)="exportToExcel('serviceRevenue')">
          <i class="mdi mdi-cash-multiple text-success mr-1"></i> Xuất doanh thu theo dịch vụ
        </button>
        <div class="dropdown-divider"></div>
        <button class="dropdown-item" (click)="exportToExcel('all')">
          <i class="mdi mdi-file-document text-info mr-1"></i> Xuất tất cả dữ liệu
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Thẻ thống kê tổng quan -->
<div class="row mb-2" *ngIf="!isLoading && servicesData && servicesData.length > 0">
  <div class="col-md-6 mb-2 pr-1 pl-1">
    <div class="card shadow-sm border-0"
      style="background: linear-gradient(to right, #4facfe, #00f2fe); border-radius: 10px;">
      <div class="card-body text-white py-1 px-2">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-food-fork-drink mdi-24px mr-2"></i>
          <div>
            <h5 class="card-title mb-0">Tổng số dịch vụ đã bán</h5>
            <h3 class="font-weight-bold mb-0">{{ totalServicesSold | number }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 mb-2 pr-1 pl-1">
    <div class="card shadow-sm border-0"
      style="background: linear-gradient(to right, #fa709a, #fee140); border-radius: 10px;">
      <div class="card-body text-white py-1 px-2">
        <div class="d-flex align-items-center">
          <i class="mdi mdi-cash-multiple mdi-24px mr-2"></i>
          <div>
            <h5 class="card-title mb-0">Tổng doanh thu</h5>
            <h3 class="font-weight-bold mb-0">{{ formatCurrency(totalRevenue) }}</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hiển thị trạng thái đang tải -->
<div class="text-center p-3" *ngIf="isLoading">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Đang tải...</span>
  </div>
  <p class="mt-1">Đang tải dữ liệu...</p>
</div>

<!-- Hiển thị lỗi API nếu có -->
<div class="alert alert-danger py-1 px-2" *ngIf="!isLoading && apiError">
  <i class="mdi mdi-alert-circle mr-1"></i>
  Không thể tải dữ liệu từ API. Đang hiển thị dữ liệu mẫu.
</div>

<!-- Không có dữ liệu -->
<div *ngIf="!isLoading && (!servicesData || servicesData.length === 0)" class="alert alert-info py-1 px-2">
  <p class="mb-0">Không có dữ liệu dịch vụ để hiển thị trong khoảng thời gian đã chọn.</p>
</div>

<!-- Nội dung thống kê -->
<div *ngIf="!isLoading && servicesData && servicesData.length > 0">
  <div class="row">
    <!-- Biểu đồ tròn - Thống kê dịch vụ phổ biến -->
    <div class="col-md-4 mb-2 pl-1 pr-1">
      <div class="card shadow-sm h-100" style="border-radius: 10px;">
        <div class="card-header bg-transparent border-0 py-1 px-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-food-fork-drink mdi-24px text-primary mr-1"></i>
            <h5 class="mb-0">Top dịch vụ phổ biến</h5>
          </div>
        </div>
        <div class="card-body pt-0 pb-1 px-1">
          <div id="servicesPopularityPieChart">
            <apx-chart [series]="pieChartOptions.series!" [chart]="pieChartOptions.chart!"
              [labels]="pieChartOptions.labels!" [responsive]="pieChartOptions.responsive!"
              [colors]="pieChartOptions.colors!" [dataLabels]="pieChartOptions.dataLabels!"
              [legend]="pieChartOptions.legend!" [tooltip]="pieChartOptions.tooltip!"
              [plotOptions]="pieChartOptions.plotOptions!" [states]="pieChartOptions.states!"
              [fill]="pieChartOptions.fill!"></apx-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Biểu đồ cột - Doanh thu theo dịch vụ -->
    <div class="col-md-4 mb-2 pl-1 pr-1">
      <div class="card shadow-sm h-100" style="border-radius: 10px;">
        <div class="card-header bg-transparent border-0 py-1 px-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-bar mdi-24px text-info mr-1"></i>
            <h5 class="mb-0">Doanh thu theo dịch vụ</h5>
          </div>
        </div>
        <div class="card-body pt-0 pb-1 px-1">
          <div id="serviceRevenueBarChart">
            <apx-chart
              [series]="barChartOptions.series!"
              [chart]="barChartOptions.chart!"
              [xaxis]="barChartOptions.xaxis!"
              [yaxis]="barChartOptions.yaxis!"
              [dataLabels]="barChartOptions.dataLabels!"
              [colors]="barChartOptions.colors!"
              [tooltip]="barChartOptions.tooltip!"
              [plotOptions]="barChartOptions.plotOptions!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>

    <!-- Biểu đồ ngang - So sánh số lượng/doanh thu -->
    <div class="col-md-4 mb-2 pl-1 pr-1">
      <div class="card shadow-sm h-100" style="border-radius: 10px;">
        <div class="card-header bg-transparent border-0 py-1 px-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-chart-timeline-variant mdi-24px text-success mr-1"></i>
            <h5 class="mb-0">So sánh số lượng/doanh thu</h5>
          </div>
        </div>
        <div class="card-body pt-0 pb-1 px-1">
          <div id="compareChart">
            <apx-chart
              [series]="compareChartOptions.series!"
              [chart]="compareChartOptions.chart!"
              [xaxis]="compareChartOptions.xaxis!"
              [yaxis]="compareChartOptions.yaxis!"
              [dataLabels]="compareChartOptions.dataLabels!"
              [colors]="compareChartOptions.colors!"
              [tooltip]="compareChartOptions.tooltip!"
              [legend]="compareChartOptions.legend!"
              [stroke]="compareChartOptions.stroke!"
              [fill]="compareChartOptions.fill!"
            ></apx-chart>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bảng chi tiết dịch vụ -->
  <div class="row mb-2">
    <div class="col-12 pl-1 pr-1">
      <div class="card shadow-sm" style="border-radius: 10px;">
        <div class="card-header bg-transparent border-0 py-1 px-2">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-format-list-bulleted mdi-24px text-info mr-1"></i>
            <h5 class="mb-0">Chi tiết theo dịch vụ</h5>
          </div>
        </div>
        <div class="card-body py-1 px-1">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Tên dịch vụ</th>
                  <th>Số lượng</th>
                  <th>Tỷ lệ</th>
                  <th>Doanh thu</th>
                  <th>Tỷ lệ DT</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let service of servicesData; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="service-icon" [style.background-color]="getServiceColor(i)">
                        <i class="mdi mdi-food-fork-drink"></i>
                      </div>
                      <span class="ml-1 text-truncate" style="max-width: 200px;">{{ service.serviceName }}</span>
                    </div>
                  </td>
                  <td>{{ service.quantity | number }}</td>
                  <td>{{ calculatePercentage(service.quantity, totalServicesSold) }}</td>
                  <td>{{ formatCurrency(service.revenue) }}</td>
                  <td>{{ calculatePercentage(service.revenue, totalRevenue) }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
